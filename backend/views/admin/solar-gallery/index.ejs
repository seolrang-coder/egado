<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>íƒœì–‘ê´‘ ê°¤ëŸ¬ë¦¬ ê´€ë¦¬ | <%= typeof orgName !== 'undefined' ? orgName : 'ì „êµ­ì¥ì• ì¸ë‚˜ëˆ”í˜‘ë™ì¡°í•©' %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .gallery-item {
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .gallery-item img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 0.25rem;
      object-fit: cover;
    }
    .upload-area {
      border: 2px dashed #dee2e6;
      border-radius: 0.5rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .upload-area:hover {
      border-color: #ffc107;
      background-color: #fffbf0;
    }
    .upload-area.dragover {
      border-color: #ffc107;
      background-color: #fffbf0;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/nanum.html">
        <strong><%= typeof orgName !== 'undefined' ? orgName : 'ì „êµ­ì¥ì• ì¸ë‚˜ëˆ”í˜‘ë™ì¡°í•©' %></strong>
      </a>
      <div class="ms-auto d-flex gap-2 align-items-center flex-wrap">
        <span class="navbar-text">ì•ˆë…•í•˜ì„¸ìš”, <strong><%= currentUser.username %></strong>ë‹˜</span>
        <a href="/coop/admin/users" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-people me-1"></i>íšŒì› ê´€ë¦¬
        </a>
        <a href="/coop/admin/accessions" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-file-earmark-text me-1"></i>ê°€ì… ì‹ ì²­ ê´€ë¦¬
        </a>
        <a href="/coop/admin/solar-gallery" class="btn btn-primary btn-sm">
          <i class="bi bi-images me-1"></i>íƒœì–‘ê´‘ ê°¤ëŸ¬ë¦¬
        </a>
        <a href="/coop/admin/settings" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-gear me-1"></i>ì‚¬ì´íŠ¸ ì„¤ì •
        </a>
        <a href="/nanum.html" class="btn btn-outline-secondary btn-sm">í™ˆìœ¼ë¡œ</a>
        <form action="/coop/logout" method="post" class="d-inline">
          <button type="submit" class="btn btn-outline-secondary btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
        </form>
      </div>
    </div>
  </nav>

  <main class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="mb-1">íƒœì–‘ê´‘ ê°¤ëŸ¬ë¦¬ ê´€ë¦¬</h2>
        <p class="text-muted mb-0">íƒœì–‘ê´‘ ì‹œì„¤êµ¬ì¶• ì˜ˆì‹œ ì‚¬ì§„ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
      </div>
    </div>

    <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ í¼ -->
    <div class="card mb-4">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="bi bi-cloud-upload me-2"></i>ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h5>
      </div>
      <div class="card-body">
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">ì´ë¯¸ì§€ íŒŒì¼ <span class="text-danger">*</span></label>
              <div class="upload-area" id="uploadArea">
                <i class="bi bi-cloud-upload fs-1 text-muted d-block mb-2"></i>
                <p class="mb-1">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                <small class="text-muted">JPG, PNG, GIF, WEBP (ìµœëŒ€ 50MB)</small>
                <input type="file" id="imageInput" name="image" accept="image/*" class="d-none" required>
              </div>
              <div id="imagePreview" class="mt-2"></div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">ì œëª© <span class="text-danger">*</span></label>
                <input type="text" name="title" class="form-control" placeholder="ì˜ˆ: íƒœì–‘ê´‘ ë°œì „ì†Œ ì¤€ê³µ" required>
              </div>
              <div class="mb-3">
                <label class="form-label">ìƒíƒœ ë°°ì§€</label>
                <select name="status_badge" class="form-select">
                  <option value="">ì„ íƒ ì•ˆí•¨</option>
                  <option value="ì‹œì„¤êµ¬ì¶•">ì‹œì„¤êµ¬ì¶•</option>
                  <option value="ì„¤ì¹˜ì™„ë£Œ">ì„¤ì¹˜ì™„ë£Œ</option>
                  <option value="ì‹œê³µì§„í–‰">ì‹œê³µì§„í–‰</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">ë‚ ì§œ</label>
                <input type="text" name="date_text" class="form-control" placeholder="ì˜ˆ: 2025ë…„ 06ì›” 29ì¼">
              </div>
              <div class="mb-3">
                <label class="form-label">í‘œì‹œ ìˆœì„œ</label>
                <input type="number" name="display_order" class="form-control" value="0" min="0">
              </div>
            </div>
          </div>
          <div class="mt-3">
            <button type="submit" class="btn btn-warning">
              <i class="bi bi-upload me-1"></i>ì—…ë¡œë“œ
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ê°¤ëŸ¬ë¦¬ ëª©ë¡ -->
    <div class="card">
      <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-images me-2"></i>ê°¤ëŸ¬ë¦¬ ëª©ë¡</h5>
      </div>
      <div class="card-body">
        <div id="galleryList">
          <% if (items.length === 0) { %>
            <div class="text-center py-5 text-muted">
              <i class="bi bi-images fs-1 d-block mb-3"></i>
              <p>ë“±ë¡ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          <% } else { %>
            <% items.forEach((item, index) => { %>
              <div class="gallery-item" data-id="<%= item.id %>">
                <div class="row align-items-center">
                  <div class="col-md-2">
                    <img src="<%= item.image_path %>" alt="<%= item.title %>" class="img-fluid">
                  </div>
                  <div class="col-md-6">
                    <h6 class="mb-1"><%= item.title %></h6>
                    <% if (item.status_badge) { %>
                      <span class="badge bg-warning rounded-pill me-2"><%= item.status_badge %></span>
                    <% } %>
                    <% if (item.date_text) { %>
                      <small class="text-muted">
                        <i class="bi bi-calendar3 me-1"></i><%= item.date_text %>
                      </small>
                    <% } %>
                    <div class="mt-2">
                      <small class="text-muted">ìˆœì„œ: <%= item.display_order %> | 
                        ìƒíƒœ: <% if (item.is_active) { %>í™œì„±<% } else { %>ë¹„í™œì„±<% } %>
                      </small>
                    </div>
                  </div>
                  <div class="col-md-4 text-end">
                    <button class="btn btn-sm btn-outline-primary edit-btn" data-id="<%= item.id %>">
                      <i class="bi bi-pencil"></i> ìˆ˜ì •
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-btn" data-id="<%= item.id %>">
                      <i class="bi bi-trash"></i> ì‚­ì œ
                    </button>
                  </div>
                </div>
              </div>
            <% }); %>
          <% } %>
        </div>
      </div>
    </div>
  </main>

  <!-- ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ê°¤ëŸ¬ë¦¬ í•­ëª© ìˆ˜ì •</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" name="id" id="editId">
            <div class="mb-3">
              <label class="form-label">ì œëª© <span class="text-danger">*</span></label>
              <input type="text" name="title" id="editTitle" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">ìƒíƒœ ë°°ì§€</label>
              <select name="status_badge" id="editStatusBadge" class="form-select">
                <option value="">ì„ íƒ ì•ˆí•¨</option>
                <option value="ì‹œì„¤êµ¬ì¶•">ì‹œì„¤êµ¬ì¶•</option>
                <option value="ì„¤ì¹˜ì™„ë£Œ">ì„¤ì¹˜ì™„ë£Œ</option>
                <option value="ì‹œê³µì§„í–‰">ì‹œê³µì§„í–‰</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">ë‚ ì§œ</label>
              <input type="text" name="date_text" id="editDateText" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">í‘œì‹œ ìˆœì„œ</label>
              <input type="number" name="display_order" id="editDisplayOrder" class="form-control" min="0">
            </div>
            <div class="mb-3">
              <label class="form-label">í™œì„± ìƒíƒœ</label>
              <select name="is_active" id="editIsActive" class="form-select">
                <option value="1">í™œì„±</option>
                <option value="0">ë¹„í™œì„±</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ì—…ë¡œë“œ ì˜ì—­ í´ë¦­
    document.getElementById('uploadArea').addEventListener('click', () => {
      document.getElementById('imageInput').click();
    });

    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    document.getElementById('imageInput').addEventListener('change', function(e) {
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'img-fluid rounded';
          img.style.maxHeight = '200px';
          preview.appendChild(img);
        };
        reader.readAsDataURL(this.files[0]);
      }
    });

    // ì—…ë¡œë“œ í¼ ì œì¶œ
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      try {
        const response = await fetch('/coop/admin/solar-gallery', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        if (result.success) {
          alert('ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload();
        } else {
          alert(result.error || 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ìˆ˜ì • ë²„íŠ¼
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.dataset.id;
        const item = document.querySelector(`.gallery-item[data-id="${id}"]`);
        const title = item.querySelector('h6').textContent;
        const badge = item.querySelector('.badge')?.textContent || '';
        const date = item.querySelector('small')?.textContent.replace('ğŸ“… ', '') || '';
        
        document.getElementById('editId').value = id;
        document.getElementById('editTitle').value = title;
        document.getElementById('editStatusBadge').value = badge;
        document.getElementById('editDateText').value = date;
        
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
      });
    });

    // ì €ì¥ ë²„íŠ¼
    document.getElementById('saveEditBtn').addEventListener('click', async function() {
      const form = document.getElementById('editForm');
      const formData = new FormData(form);
      const data = Object.fromEntries(formData);
      
      try {
        const response = await fetch(`/coop/admin/solar-gallery/${data.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload();
        } else {
          alert(result.error || 'ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ì‚­ì œ ë²„íŠ¼
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        if (!confirm('ì •ë§ë¡œ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
        
        const id = this.dataset.id;
        
        fetch(`/coop/admin/solar-gallery/${id}`, {
          method: 'DELETE'
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.reload();
          } else {
            alert(result.error || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      });
    });
  </script>
</body>
</html>

