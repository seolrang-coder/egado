<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>회원 상세 | <%= typeof orgName !== 'undefined' ? orgName : '관악구장애인단체연합회' %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .status-badge {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      font-weight: 600;
      display: inline-block;
    }
    .status-active { background: #d4edda; color: #155724; }
    .status-inactive { background: #f8d7da; color: #721c24; }
    .badge-admin { background: #4b4b8f; color: #fff; }
    .info-box {
      background: #f8f9fa;
      border-left: 4px solid #4b4b8f;
      padding: 1rem;
      border-radius: 0.25rem;
      margin-bottom: 1rem;
    }
    .check-result {
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    .check-result.available {
      color: #28a745;
    }
    .check-result.unavailable {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="<%= typeof orgType !== 'undefined' && orgType === 'coop' ? '/nanum.html' : (typeof orgType !== 'undefined' && orgType === 'golf' ? '/aboutgolf.html' : '/index.html') %>">
        <strong><%= typeof orgName !== 'undefined' ? orgName : '관악구장애인단체연합회' %></strong>
      </a>
      <div class="ms-auto d-flex gap-2 align-items-center flex-wrap">
        <span class="navbar-text">안녕하세요, <strong><%= currentUser.username %></strong>님</span>
        <a href="<%= typeof orgType !== 'undefined' && orgType === 'coop' ? '/coop/admin/users' : (typeof orgType !== 'undefined' && orgType === 'golf' ? '/golf/admin/users' : '/admin/users') %>" class="btn btn-primary btn-sm">
          <i class="bi bi-people me-1"></i>회원 관리
        </a>
        <% if (typeof orgType !== 'undefined' && orgType === 'coop') { %>
        <a href="/coop/admin/accessions" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-file-earmark-text me-1"></i>가입 신청 관리
        </a>
        <a href="/coop/admin/solar-gallery" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-images me-1"></i>태양광 갤러리
        </a>
        <a href="/coop/admin/settings" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-gear me-1"></i>사이트 설정
        </a>
        <% } %>
        <% if (typeof orgType !== 'undefined' && orgType === 'golf') { %>
        <a href="/golf/admin/settings" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-gear me-1"></i>사이트 설정
        </a>
        <a href="/golf/admin/gallery" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-images me-1"></i>갤러리 관리
        </a>
        <% } %>
        <% if (typeof orgType === 'undefined' || orgType === 'main') { %>
        <a href="/admin/sponsors" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-heart me-1"></i>후원 관리
        </a>
        <a href="/admin/settings" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-gear me-1"></i>사이트 설정
        </a>
        <% } %>
        <a href="<%= typeof orgType !== 'undefined' && orgType === 'coop' ? '/nanum.html' : (typeof orgType !== 'undefined' && orgType === 'golf' ? '/aboutgolf.html' : '/index.html') %>" class="btn btn-outline-secondary btn-sm">홈으로</a>
        <form action="<%= typeof orgType !== 'undefined' && orgType === 'coop' ? '/coop/logout' : (typeof orgType !== 'undefined' && orgType === 'golf' ? '/golf/logout' : '/logout') %>" method="post" class="d-inline">
          <button type="submit" class="btn btn-outline-secondary btn-sm">로그아웃</button>
        </form>
      </div>
    </div>
  </nav>

  <main class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>회원 상세</h2>
      <div>
        <% if (user.is_active) { %>
          <span class="status-badge status-active">활성</span>
        <% } else { %>
          <span class="status-badge status-inactive">비활성</span>
        <% } %>
        <% if (user.is_admin) { %>
          <span class="badge badge-admin ms-2">관리자</span>
        <% } %>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-8">
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-person-fill me-2"></i>기본 정보</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label text-muted small">회원번호</label>
                <p class="mb-0 fw-bold"><%= user.id %></p>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">아이디</label>
                <p class="mb-0 fw-bold"><%= user.username %></p>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">이름</label>
                <p class="mb-0"><%= user.name || '-' %></p>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">이메일</label>
                <p class="mb-0">
                  <% if (user.email) { %>
                    <a href="mailto:<%= user.email %>"><%= user.email %></a>
                  <% } else { %>
                    -
                  <% } %>
                </p>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">연락처</label>
                <p class="mb-0">
                  <% if (user.phone) { %>
                    <a href="tel:<%= user.phone %>"><%= user.phone %></a>
                  <% } else { %>
                    -
                  <% } %>
                </p>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">생년월일</label>
                <p class="mb-0"><%= user.birthdate || '-' %></p>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">성별</label>
                <p class="mb-0">
                  <% if (user.gender === 'M') { %>
                    남성
                  <% } else if (user.gender === 'F') { %>
                    여성
                  <% } else { %>
                    -
                  <% } %>
                </p>
              </div>
              <div class="col-md-6">
                <label class="form-label text-muted small">가입일</label>
                <p class="mb-0"><%= new Date(user.created_at).toLocaleString('ko-KR') %></p>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>활동 정보</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label text-muted small">작성한 게시글 수</label>
                <p class="mb-0"><strong><%= user.postCount || 0 %></strong>개</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-gear me-2"></i>관리</h5>
          </div>
          <div class="card-body">
            <!-- 정보 수정 -->
            <form id="editForm" class="mb-3">
              <h6 class="mb-3">정보 수정</h6>
              <div class="mb-3">
                <label class="form-label small">아이디</label>
                <input type="text" name="username" id="usernameInput" class="form-control form-control-sm" value="<%= user.username %>" minlength="3" required>
                <div id="usernameCheckResult" class="check-result mt-1"></div>
              </div>
              <div class="mb-3">
                <label class="form-label small">이름</label>
                <input type="text" name="name" class="form-control form-control-sm" value="<%= user.name || '' %>">
              </div>
              <div class="mb-3">
                <label class="form-label small">이메일</label>
                <input type="email" name="email" class="form-control form-control-sm" value="<%= user.email || '' %>">
              </div>
              <div class="mb-3">
                <label class="form-label small">연락처</label>
                <input type="tel" name="phone" class="form-control form-control-sm" value="<%= user.phone || '' %>">
              </div>
              <button type="submit" class="btn btn-primary btn-sm w-100">
                <i class="bi bi-check-circle me-1"></i>정보 수정
              </button>
            </form>

            <hr>

            <!-- 활성상태 변경 -->
            <form id="statusForm" class="mb-3">
              <h6 class="mb-3">활성상태 변경</h6>
              <select name="is_active" class="form-select form-select-sm mb-3" id="statusSelect">
                <option value="true" <%= user.is_active ? 'selected' : '' %>>활성</option>
                <option value="false" <%= !user.is_active ? 'selected' : '' %>>비활성</option>
              </select>
              <button type="submit" class="btn btn-warning btn-sm w-100">
                <i class="bi bi-toggle-on me-1"></i>상태 변경
              </button>
            </form>

            <hr>

            <!-- 비밀번호 초기화 -->
            <form id="passwordForm" class="mb-3">
              <h6 class="mb-3">비밀번호 초기화</h6>
              <div class="mb-3">
                <label class="form-label small">새 비밀번호</label>
                <input type="password" name="newPassword" class="form-control form-control-sm" placeholder="6자 이상" minlength="6" required>
              </div>
              <button type="submit" class="btn btn-info btn-sm w-100">
                <i class="bi bi-key me-1"></i>비밀번호 초기화
              </button>
            </form>

            <hr>

            <!-- 회원 삭제 -->
            <% if (user.id !== currentUser.id) { %>
              <% 
                const deletePath = typeof orgType !== 'undefined' && orgType === 'coop' ? '/coop/admin/users/' : (typeof orgType !== 'undefined' && orgType === 'golf' ? '/golf/admin/users/' : '/admin/users/');
              %>
              <form action="<%= deletePath %><%= user.id %>/delete" method="post" onsubmit="return confirm('정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.');">
                <button type="submit" class="btn btn-danger btn-sm w-100">
                  <i class="bi bi-trash me-1"></i>회원 삭제
                </button>
              </form>
            <% } else { %>
              <button type="button" class="btn btn-danger btn-sm w-100" disabled>
                <i class="bi bi-exclamation-triangle me-1"></i>자기 자신은 삭제할 수 없습니다
              </button>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 아이디 중복 확인
    const usernameInput = document.getElementById('usernameInput');
    const usernameCheckResult = document.getElementById('usernameCheckResult');
    let usernameCheckTimeout;
    let isUsernameAvailable = false;
    const originalUsername = '<%= user.username %>';

    usernameInput.addEventListener('input', function() {
      const username = this.value.trim();
      
      if (username === originalUsername) {
        usernameCheckResult.textContent = '';
        usernameCheckResult.className = 'check-result';
        isUsernameAvailable = true;
        return;
      }

      if (username.length < 3) {
        usernameCheckResult.textContent = '아이디는 3자 이상이어야 합니다.';
        usernameCheckResult.className = 'check-result unavailable';
        isUsernameAvailable = false;
        return;
      }

      clearTimeout(usernameCheckTimeout);
      usernameCheckResult.textContent = '확인 중...';
      usernameCheckResult.className = 'check-result';

      usernameCheckTimeout = setTimeout(async () => {
        try {
          const apiPath = '<%= typeof orgType !== "undefined" && orgType === "coop" ? "/api/coop/check-username" : (typeof orgType !== "undefined" && orgType === "golf" ? "/api/golf/check-username" : "/api/check-username") %>';
          const response = await fetch(apiPath, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username })
          });

          const result = await response.json();
          if (result.available) {
            usernameCheckResult.textContent = result.message || '사용 가능한 아이디입니다.';
            usernameCheckResult.className = 'check-result available';
            isUsernameAvailable = true;
          } else {
            usernameCheckResult.textContent = result.message || '이미 사용 중인 아이디입니다.';
            usernameCheckResult.className = 'check-result unavailable';
            isUsernameAvailable = false;
          }
        } catch (error) {
          console.error('Error:', error);
          usernameCheckResult.textContent = '확인 중 오류가 발생했습니다.';
          usernameCheckResult.className = 'check-result unavailable';
          isUsernameAvailable = false;
        }
      }, 500);
    });

    // 정보 수정
    document.getElementById('editForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const username = formData.get('username').trim();
      
      if (username !== originalUsername && !isUsernameAvailable) {
        alert('사용 가능한 아이디를 입력하거나 중복 확인을 기다려주세요.');
        return;
      }

      if (username.length < 3) {
        alert('아이디는 3자 이상이어야 합니다.');
        return;
      }

      const data = {
        username: username,
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone')
      };
      
      try {
        const basePath = '<%= typeof orgType !== "undefined" && orgType === "coop" ? "/coop/admin/users" : (typeof orgType !== "undefined" && orgType === "golf" ? "/golf/admin/users" : "/admin/users") %>';
        const response = await fetch(basePath + '/<%= user.id %>', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          if (username !== originalUsername && parseInt('<%= user.id %>') === parseInt('<%= currentUser.id %>')) {
            // 자기 자신의 아이디를 변경한 경우 - 세션이 업데이트되었으므로 페이지 새로고침
            alert('정보가 수정되었습니다. 아이디가 변경되어 세션이 업데이트되었습니다.');
            location.reload();
          } else {
            alert('정보가 수정되었습니다.');
            location.reload();
          }
        } else {
          alert(result.error || '정보 수정 중 오류가 발생했습니다.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('정보 수정 중 오류가 발생했습니다.');
      }
    });

    // 활성상태 변경
    document.getElementById('statusForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const is_active = document.getElementById('statusSelect').value;
      
      try {
        const basePath = '<%= typeof orgType !== "undefined" && orgType === "coop" ? "/coop/admin/users" : (typeof orgType !== "undefined" && orgType === "golf" ? "/golf/admin/users" : "/admin/users") %>';
        const response = await fetch(basePath + '/<%= user.id %>/status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ is_active })
        });

        const result = await response.json();
        if (result.success) {
          alert('상태가 변경되었습니다.');
          location.reload();
        } else {
          alert('상태 변경 중 오류가 발생했습니다.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('상태 변경 중 오류가 발생했습니다.');
      }
    });

    // 비밀번호 초기화
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const newPassword = formData.get('newPassword');
      
      if (!newPassword || newPassword.length < 6) {
        alert('비밀번호는 6자 이상이어야 합니다.');
        return;
      }
      
      if (!confirm('비밀번호를 초기화하시겠습니까?')) {
        return;
      }
      
      try {
        const basePath = '<%= typeof orgType !== "undefined" && orgType === "coop" ? "/coop/admin/users" : (typeof orgType !== "undefined" && orgType === "golf" ? "/golf/admin/users" : "/admin/users") %>';
        const response = await fetch(basePath + '/<%= user.id %>/reset-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ newPassword })
        });

        const result = await response.json();
        if (result.success) {
          alert('비밀번호가 성공적으로 변경되었습니다.\n\n새 비밀번호: ' + newPassword + '\n\n이제 이 비밀번호로 로그인할 수 있습니다.');
          this.reset();
        } else {
          alert(result.error || '비밀번호 초기화 중 오류가 발생했습니다.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('비밀번호 초기화 중 오류가 발생했습니다.');
      }
    });
  </script>
</body>
</html>

